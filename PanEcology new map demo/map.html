<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Add a default marker</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
	<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
	<style>
		body {
			margin: 0;
			padding: 0;
		}

		#map {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 100%;
		}

		.mapboxgl-popup {
			max-width: 200px;
		}
	</style>
	<style>
		#file {
			position: absolute;
			top: 0;
			left: 0;
		}
	</style>
</head>

<body>
	<div id="map"></div>
	<input type="file" id="file" name="file" />
	<script>
		var stepped = 0, rowCount = 0, errorCount = 0, firstError = undefined;
		var start, end;
		var firstRun = true;
		var map = new maplibregl.Map({
			container: 'map',
			style:
				'https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL',
			center: new maplibregl.LngLat(-158.33, 68.25),
			zoom: 3
		});


		const fileInput = document.getElementById('file');
		fileInput.onchange = () => {
			var config = buildConfig();
			$('#file').parse({
				config: config,
				before: function (file, inputElem) {
					start = now();
					console.log("Parsing file...", file);
				},
				error: function (err, file) {
					console.log("ERROR:", err, file);
					firstError = firstError || err;
					errorCount++;
				},
				complete: function () {
					end = now();
					printStats("Done with all files");
				}
			});
			function printStats(msg) {
				if (msg)
					console.log(msg);
				console.log("       Time:", (end - start || "(Unknown; your browser does not support the Performance API)"), "ms");
				console.log("  Row count:", rowCount);
				if (stepped)
					console.log("    Stepped:", stepped);
				console.log("     Errors:", errorCount);
				if (errorCount)
					console.log("First error:", firstError);
			}
			function buildConfig() {
				return {
					header: true,
					dynamicTyping: true,
					skipEmptyLines: true,
					complete: completeFn,
					error: errorFn,
				};
			}
			function completeFn(results) {
				end = now();

				if (results && results.errors) {
					if (results.errors) {
						errorCount = results.errors.length;
						firstError = results.errors[0];
					}
					if (results.data && results.data.length > 0)
						rowCount = results.data.length;
				}

				printStats("Parse complete");
				console.log("    Results:", results);
				for (i = 0; i < results.data.length; i++) {
					var popup = new maplibregl.Popup({ offset: 25 }).setText(
						results.data[i].ScientificName
					);
					var el = document.createElement('div');
					el.id = 'marker';
					var marker = new maplibregl.Marker()
						.setLngLat([results.data[i].DecimalLongitude, results.data[i].DecimalLatitude])
						.setPopup(popup)
						.addTo(map);
				}
			}
			function errorFn(err, file) {
				end = now();
				console.log("ERROR:", err, file);
			}
			function now() {
				return typeof window.performance !== 'undefined'
					? window.performance.now()
					: 0;
			}
		}
		// for (const feature of data) {
		// 	// create a HTML element for each feature
		// 	const el = document.createElement('div');
		// 	el.className = 'marker';

		// 	// make a marker for each feature and add to the map
		// 	new mapboxgl.Marker(el).setLngLat(feature.geometry.coordinates).addTo(map);
		// }
	</script>

</body>

</html>